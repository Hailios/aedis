name: Coverage

on:
  push:
    branches:
      - master
jobs:
  posix:
    defaults:
      run:
        shell: bash

    runs-on: ubuntu-22.04
    env:
      CXX: g++-11
      CXXFLAGS: -g -O0 -std=c++20 --coverage -fkeep-inline-functions -fkeep-static-functions
      LDFLAGS: --coverage
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Install CMake
      run: sudo apt-get -y install cmake
    - name: Install lcov
      run: sudo apt-get -y install lcov
    - name: Install compiler
      run: sudo apt-get -y install g++-11
    - name: Install Redis
      run: sudo apt-get -y install redis-server
    - name: Install boost
      uses: MarkusJx/install-boost@v2.3.0
      id: install-boost
      with:
        boost_version: 1.79.0
        platform_version: 22.04
    - name: Run CMake
      run: |
        BOOST_ROOT=${{steps.install-boost.outputs.BOOST_ROOT}} cmake -DCMAKE_CXX_FLAGS="${{env.CXXFLAGS}}" -DCMAKE_EXE_LINKER_FLAGS="${{env.LDFLAGS}}"
    - name: Build
      run: make
    - name: Test
      run: make test VERBOSE=1
    - name: Make the coverage file
      run: make coverage
    - name: Upload to codecov
      run: |
        bash <(curl -s https://codecov.io/bash) -f coverage.info || echo "Codecov did not collect coverage reports"

